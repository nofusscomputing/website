stages:
    - validation
    - build
    - release
    - publish


variables:
    GIT_SUBMODULE_STRATEGY: recursive
    MY_PROJECT_ID: "13001358"


include:
  - project: nofusscomputing/projects/gitlab-ci
    ref: 46cc1fbb6a878e485af39e679b5184a9912c2e7f
    file:
      - conventional_commits/.gitlab-ci.yml
      - gitlab_release/.gitlab-ci.yml


markdown lint:
    image: node:alpine3.14
    stage: validation
    before_script:
        - npm install markdownlint-cli2 --global
        - npm install markdownlint-cli2-formatter-junit --global
        - mkdir -p "$CI_PROJECT_DIR/artifacts/$CI_JOB_STAGE/$CI_JOB_NAME"
        - mkdir -p "$CI_PROJECT_DIR/artifacts/$CI_JOB_STAGE/tests"
    script:
        - markdownlint-cli2 "**/*.md" "!gitlab-ci" 1>&1 || EXITCODE=$?
        - echo DEBUG EXITCODE[$EXITCODE]
        - mv markdown.junit.xml $CI_PROJECT_DIR/artifacts/$CI_JOB_STAGE/tests/markdown.junit.xml
    artifacts:
        expire_in: 3 days
        when: always
        paths:
            - "$CI_PROJECT_DIR/artifacts/*"
        reports:
            junit:
                - "$CI_PROJECT_DIR/artifacts/$CI_JOB_STAGE/tests/*.junit.xml"
    rules:
        - if: '$CI_COMMIT_BRANCH == "master"'
          when: never
        - if: '$CI_COMMIT_BRANCH'
          exists:
            - "**.md"
        - when: never

Static Pages:
  image: python:3.7.5-buster
  stage: build
  variables:
    GIT_DEPTH: 0
  before_script:
    - pip install --upgrade pip -r requirements.txt
  script:
#    - mkdir static
#    - cp README.md pages/
    - mkdocs build --clean --strict
    - rm build/sitemap*
  artifacts:
    paths:
      - build
  rules:
    - if: '$CI_COMMIT_BRANCH'
      when: always
    - when: never


Gitlab Release:
    extends:
        - .gitlab_release


pages:
  stage: publish
  variables:
    GIT_STRATEGY: none
  script:
    - mv build public
  needs: ['Static Pages']
  environment: 
    name: staging
    url: $CI_PAGES_URL
  artifacts:
    paths:
    - public
  rules:
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "master"'
      when: always
    - when: never


